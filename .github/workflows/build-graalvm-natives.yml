name: Build GraalVM native images

on:
  workflow_dispatch:

env:
  # Hardcoded manual version (update when releasing)
  VERSION: 1.2.0

jobs:
  native-image:
    name: GraalVM Native Image (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
          - os: windows-latest
            platform: windows-x86_64
          - os: macos-latest
            platform: macos-arm64
          - os: macos-15-intel
            platform: macos-x86_64

    timeout-minutes: 60

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: '21'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: gradle
          native-image-job-reports: 'true'

      - name: Make Gradle wrapper executable (non-Windows)
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      - name: Build native distribution ZIP
        run: ./gradlew :openccjavacli:nativeDistZip --no-daemon --stacktrace

      - name: Rename native ZIP with version
        shell: bash
        run: |
          set -euo pipefail

          ZIP_FILE=$(find . -type f -path "*/build/distributions/*-native-*.zip" | head -n 1)

          if [ -z "$ZIP_FILE" ]; then
            echo "Native ZIP not found"
            exit 1
          fi

          echo "Found: $ZIP_FILE"

          NEW_NAME="OpenccJavaCli-${VERSION}-${{ matrix.platform }}-native.zip"

          mkdir -p release
          cp "$ZIP_FILE" "release/$NEW_NAME"

          echo "Renamed to: release/$NEW_NAME"

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJavaCli-${{ env.VERSION }}-${{ matrix.platform }}-native
          path: release/*.zip
          if-no-files-found: error
          compression-level: 6