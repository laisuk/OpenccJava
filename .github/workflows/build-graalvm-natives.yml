name: Build GraalVM native images

on:
  # Manual trigger only – run from the Actions tab
  workflow_dispatch:

jobs:
  native-image:
    name: GraalVM Native Image (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    timeout-minutes: 60

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      # Use GraalVM as the JDK (Java 21; fine for Java 8-targeted code)
      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: '21'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: gradle
          native-image-job-reports: 'true'

      - name: Make Gradle wrapper executable (non-Windows)
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      # IMPORTANT:
      # Before running this workflow, ensure you have:
      #  - uncommented the org.graalvm.buildtools.native plugin
      #  - uncommented the graalvmNative { ... } + nativeDistZip task block
      - name: Build native distribution ZIP
        run: ./gradlew :openccjavacli:nativeDistZip --no-daemon --stacktrace

      # (Optional) Show where the ZIP actually ended up – helpful for debugging paths
      - name: List native distributions
        run: |
          echo "Searching for OpenccJavaCli-native-*.zip under the repo..."
          find . -maxdepth 6 -type f -name "OpenccJavaCli-native-*.zip" -print || echo "No files found yet"

      # Upload whatever OpenccJavaCli-native-*.zip was produced by the subproject,
      # regardless of whether the folder is 'openccjavacli', 'OpenccJavaCli', etc.
      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJavaCli-${{ matrix.os }}-native
          path: '**/build/distributions/OpenccJavaCli-native-*.zip'
          if-no-files-found: error
          compression-level: 6
          overwrite: false
          include-hidden-files: false
