name: Build GraalVM native images

on:
  # Manual trigger only â€“ run from the Actions tab
  workflow_dispatch:

jobs:
  native-image:
    name: GraalVM Native Image (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    # Build on Windows / Linux / macOS runners
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    timeout-minutes: 60

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      # Use GraalVM as the JDK (Java 21; ok for Java 8-targeted code)
      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: '21'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: gradle
          # Optional, but nice: adds a native-image report to the job summary
          native-image-job-reports: 'true'

      - name: Make Gradle wrapper executable (non-Windows)
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      # IMPORTANT:
      # Before running this workflow, ensure you have:
      #  - uncommented the org.graalvm.buildtools.native plugin
      #  - uncommented the graalvmNative { ... } and nativeDistZip task block
      - name: Build native distribution ZIP
        run: ./gradlew :openccjavacli:nativeDistZip --no-daemon --stacktrace

      # Upload the OS/arch-specific ZIP produced by nativeDistZip:
      # openccjavacli/build/distributions/OpenccJavaCli-native-<os>-<arch>.zip
      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJavaCli-${{ matrix.os }}-native
          path: openccjavacli/build/distributions/OpenccJavaCli-native-*.zip
          if-no-files-found: error
