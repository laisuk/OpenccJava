name: Build GraalVM native images

on:
  # Manual trigger only â€“ run this from the Actions tab
  workflow_dispatch:

jobs:
  native-image:
    name: GraalVM Native Image (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    timeout-minutes: 60

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      # Use GraalVM as the JDK (Java 21; fine even if you target Java 8)
      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: '21'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: gradle
          native-image-job-reports: 'true'

      - name: Make Gradle wrapper executable (non-Windows)
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      # IMPORTANT:
      # Before running this workflow, ensure you have:
      #  - uncommented org.graalvm.buildtools.native plugin
      #  - uncommented graalvmNative { ... } and nativeDistZip task
      - name: Build native distribution ZIP
        run: ./gradlew :openccjavacli:nativeDistZip --no-daemon --stacktrace

      # Optional: show what ZIPs were produced (debugging aid)
      - name: List native distributions
        run: |
          echo "Searching for OpenccJavaCli-*-native-*.zip under the repo..."
          find . -maxdepth 8 -type f -name "OpenccJavaCli-*-native-*.zip" -print || echo "No files found"

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJavaCli-${{ matrix.os }}-native
          # Example match: openccjavacli/build/distributions/OpenccJavaCli-1.1.1-native-windows-x86_64.zip
          path: '**/build/distributions/OpenccJavaCli-*-native-*.zip'
          if-no-files-found: error
          compression-level: 6
          overwrite: false
          include-hidden-files: false
