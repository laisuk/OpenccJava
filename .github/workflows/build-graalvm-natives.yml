name: Build GraalVM native images

on:
  workflow_dispatch:

jobs:
  native-image:
    name: GraalVM Native Image (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    timeout-minutes: 60

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: '21'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: gradle
          native-image-job-reports: 'true'

      - name: Make Gradle wrapper executable (non-Windows)
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew

      - name: Build native distribution ZIP
        run: ./gradlew :openccjavacli:nativeDistZip --no-daemon --stacktrace

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenccJavaCli-${{ matrix.os }}-native
          path: '**/build/distributions/OpenccJavaCli-*-native-*.zip'
          if-no-files-found: error
          compression-level: 6
          overwrite: false
          include-hidden-files: false
